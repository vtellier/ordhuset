<!--<link rel="import" href="../ordhuset-app/oh-behavior.html">-->
<link rel="import" href="../../bower_components/polymerfire/firebase-document.html">
<link rel="import" href="../../bower_components/polymerfire/firebase-query.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../bower_components/iron-collapse/iron-collapse.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../ordhuset-app/shared-style.html">
<link rel="import" href="../components/oh-substantive-editor.html">

<dom-module id="word-page">
  <template>
    <style include="shared-styles">
      :host {
        /*display: block;
        padding: 10px;*/
      }

      .heading {
        padding: 10px 15px;
        margin-top: 20px;
        background-color: #f3f3f3;
        border: 1px solid #dedede;
        border-top-left-radius: 5px;
        border-top-right-radius: 5px;
        font-size: 18px;
        cursor: pointer;
        -webkit-tap-highlight-color: rgba(0,0,0,0);
        width: 100%;
        text-align: left;
      }
      .heading iron-icon {
        float: right;
      }
      .content {
        padding: 15px;
        border: 1px solid #dedede;
        border-top: none;
        border-bottom-left-radius: 5px;
        border-bottom-right-radius: 5px;
        @apply(--shadow-elevation-2dp);
      }

      .substantive-button-box {
        margin-top: 20px;
        text-align: center;
      }
      .substantive-button-box paper-fab {
        display: inline-block;
        margin-left: 1ex;
      }

      table.subs-list {
        width: 100%;
      }
    </style>

    <firebase-document
        id="wordDocument"
        app-name="ordhuset"
        path="/words/[[norwegian]]"
        data="{{editableWord}}">
    </firebase-document>

    <firebase-query
        id="substantivesQuery"
        app-name="ordhuset"
        path="/substantives/[[norwegian]]"
        data="{{currentSubstantives}}">
    </firebase-query>

    <div class="card">
      <h2>[[norwegian]]</h2>
      <p>This word has [[currentSubstantives.length]] subtantives.</p>
    </div>

    <div class="card">
      <h3>Substantives</h3>

      <!-- administrator only -->
      <template is="dom-if" if="[[adminMode]]">
        <template is="dom-repeat" items="[[currentSubstantives]]" as="substantive" indexAs="index">
          <button class="heading" ident$="subs[[index]]" on-tap="toggle">
            <div class="circle">[[plusOne(index)]]</div>
            [[editableWord.norwegian]], [[substantive.singularDefinite]], [[substantive.pluralIndefinite]], [[substantive.pluralDefinite]]
            <iron-icon icon="expand-more"></iron-icon>
          </button>
          <iron-collapse ident$="subs[[index]]">
            <div class="content">
              <oh-substantive-editor
                  key="[[substantive.$key]]"
                  norwegian="[[norwegian]]"
                  on-saved="onSaved">
              </oh-substantive-editor>
            </div>
          </iron-collapse>
        </template>

        <hr>
        <iron-collapse opened$="[[newSubstantive.opened]]">
          <div class="content">
            <oh-substantive-editor
                id="newSub"
                key="[[newSubstantive.$key]]"
                norwegian="[[editableWord.norwegian]]"
                on-saved="onNewSubstantiveSaved"
                on-canceled="onCancelled">
            </oh-substantive-editor>
          </div>
        </iron-collapse>

        <div class="substantive-button-box">
          <paper-fab
              icon="add"
              on-tap="addSubstantive"
              disabled="[[!online]]"
              aria-label="Add a substantive to [[editableWord.norwegian]]"
              class="substantive-button"
              mini>
          </paper-fab>
        </div>
      </template>

      <!-- read only -->
      <template is="dom-if" if="{{!adminMode}}">
        <table class="subs-list">
          <thead>
            <th>Gender</th>
            <th>Singular indefinite</th>
            <th>Singular definite</th>
            <th>Plural indefinite</th>
            <th>Plural definite</th>
          </thead>
          <template is="dom-repeat" items="[[currentSubstantives]]" as="substantive" indexAs="index">
            <tr>
              <td>[[substantive.gender]]</td>
              <td>[[norwegian]]</td>
              <td>[[substantive.singularDefinite]]</td>
              <td>[[substantive.pluralIndefinite]]</td>
              <td>[[substantive.pluralDefinite]]</td>
            </tr>
          </template>
        </table>
      </template>
    </div>

  </template>

  <script>
    Polymer({
      is: 'word-page',
      behaviors: [Polymer.OrdhusetBehavior],

      properties: {
        subroute: Object,
        norwegian: {
          type: String,
          notify: true,
          computed: 'computeNorwegian(subroute.path)'
        },
        word: {
          type: Object,
          notify: true,
          //observer: 'dataChanged'
        },
        currentSubstantives: {
          type: Object,
        },
      },

      // Display functions

      toggle: function (event) {
        var id = event.currentTarget.getAttribute('ident');
        var collapse = this.$$('iron-collapse[ident="' + id + '"]');

        collapse.toggle();
      },

      plusOne: function(number) {
        return number + 1;
      },

      // Substantive edition functions

      addSubstantive: function() {
        this.$.newSub.setToDefault();
        this.set('newSubstantive.$key', '');
        this.set('newSubstantive.opened', true);
      },

      onNewSubstantiveSaved: function(event) {
        this.set('newSubstantive.$key', '');
        this.set('newSubstantive.opened', false);
      },

      onSaved: function(event) {
        console.log("Substantive saved! key=" + JSON.stringify(event.detail));
        //this.substantivesQuery.refresh();
      },

      onCancelled: function(event) {
        this.set('newSubstantive.opened', false);
      },

      // computed properties

      computeNorwegian: function(path) {
        return path.substring(1);
      },
    });
  </script>
</dom-module>