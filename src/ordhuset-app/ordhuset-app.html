<script src="mi-utils.js"></script>

<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/app-layout/app-layout.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/polymerfire/polymerfire.html">
<link rel="import" href="../../bower_components/app-route/app-route.html">
<link rel="import" href="../../bower_components/app-route/app-location.html">
<link rel="import" href="../../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../../bower_components/iron-selector/iron-selector.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="oh-style.html">
<link rel="import" href="svg-flags-icons.html">
<link rel="import" href="pg-default.html">
<link rel="import" href="mi-localization.html">


<dom-module id="ordhuset-app">
  <template>
    <style include="oh-style">
      :host {
        display: block;
      }
      app-drawer-layout:not([narrow]) [drawer-toggle] {
        display: none;
      }
      app-drawer section {
        background-color: var(--app-background);
        height: 100%;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
      }
      app-drawer h2 {
        margin: 8px 0 0;
        padding: 18px;
        font-size: 18px;
      }
      app-drawer paper-checkbox {
        display: block;
        padding: 18px;
      }
      app-header {
        color: #fff;
        background-color: #C62828;
        --app-header-background-front-layer: {
          background-image: url(src/img/flam.png);
          background-position: 50% 10%;
        };
      }
      [main-title] {
        font-size: 2em;
      }
    </style>
    
    <!-- Firebase application -->
    <firebase-app
      auth-domain="ordhuset-5e76d.firebaseapp.com"
      database-url="https://ordhuset-5e76d.firebaseio.com"
      api-key="AIzaSyCh0p0DgdzkdGYn-nmy_KGJkWk9mr9A46w"
      storage-bucket="ordhuset-5e76d.appspot.com"
      messaging-sender-id="573833858404">
    </firebase-app>
    
    <!-- Page routing -->
    <app-location route="{{route}}"></app-location>
    <app-route
      route="{{route}}"
      pattern="/:view"
      data="{{routeData}}"
      tail="{{subroute}}">
    </app-route>
    
    <app-drawer-layout>
      <app-drawer swipe-open slot="drawer">
        <section>
          <h2>[[localize('app-shell.menu.title')]]</h2>
          <iron-selector attr-for-selected="name" selected="[[routeData.view]]">
            <paper-button><a href="/" name="search">[[localize('app-shell.menu.Search')]]</a></paper-button>
            <paper-button><a href="/add-word" name="add-word">[[localize('app-shell.menu.AddAWord')]]</a></paper-button>
          </iron-selector>
        </section>
      </app-drawer>

      <app-header-layout>
        <app-header
            condenses="[[condenses]]"
            fixed="[[fixed]]"
            reveals="[[reveals]]"
            shadow="[[shadow]]"
            effects="[[_computeEffects(blendBackground, fadeBackground, parallaxBackground, resizeSnappedTitle, resizeTitle, waterfall)]]"
            slot="header">
          <app-toolbar>
            <paper-icon-button icon="icons:menu" drawer-toggle></paper-icon-button>
            <div main-title>Ordhuset</div>
            <div>
              <template is="dom-if" if="{{_isLanguage('no-bm', language)}}">
                <paper-button on-click="__changeLanguage">en</paper-button>
                <paper-button on-click="__changeLanguage">fr</paper-button>
              </template>
              <template is="dom-if" if="{{_isLanguage('en', language)}}">
                <paper-button on-click="__changeLanguage">no-bm</paper-button>
                <paper-button on-click="__changeLanguage">fr</paper-button>
              </template>
              <template is="dom-if" if="{{_isLanguage('fr', language)}}">
                <paper-button on-click="__changeLanguage">no-bm</paper-button>
                <paper-button on-click="__changeLanguage">en</paper-button>
              </template>
            </div>
          </app-toolbar>
        </app-header>
        
        <!-- iron-pages selects the view based on the active route -->
        <iron-pages selected="[[routeData.view]]" attr-for-selected="name" fallback-selection="search">
          <pg-default name="search" route="{{subroute}}" language$="{{language}}"></pg-default>
          <pg-add-word name="add-word" route="{{subroute}}" language$="{{language}}"></pg-add-word>
          <pg-word name="word" route="{{subroute}}" language$="{{language}}"></pg-word>
          <!-- Nb.: insert other pages here -->
        </iron-pages>
      </app-header-layout>
    </app-drawer-layout>
  </template>

  <script>
    /**
     * @customElement
     * @polymer
     */
    class OrdhusetApp extends LocalizationMixin(Polymer.Element) {
      static get is() { return 'ordhuset-app'; }
      static get properties() {
        return {
          page: {
            type: String,
            reflectToAttribute: true,
            observer: '_pageChanged'
          }
        };
      }
      static get observers() { return [
        '_routePageChanged(routeData.view)'
      ]}
      
      ready() {
        super.ready();
        this.removeAttribute('unresolved');
      }
      
      _routePageChanged(page) {
        this.page = page || 'default';
        // Close the drawer - in case the *route* change came from a link in the drawer.
        //this.drawerOpened = false;
      }
      
      _pageChanged(page, oldPage) {
        if (page != null) {
          // home route is eagerly loaded
          if (page != 'default') {
            // When a load failed, it triggered a 404 which means we need to
            // eagerly load the 404 page definition
            let cb = null;
            Polymer.importHref(
              this.resolveUrl('/src/ordhuset-app/pg-' + page + '.html'),
              cb, cb, true);
          }
        }
      }
      
      _isLanguage(lang) {
        return this.language === lang;
      }
      
      __changeLanguage(e) {
        var lang = e.path[0].firstChild.data;
        console.log("Changing to language", lang);
        this.language = lang;
      }
      
    }

    window.customElements.define(OrdhusetApp.is, OrdhusetApp);
  </script>
</dom-module>
