
<link rel="import" href="oh-style.html">
<link rel="import" href="../../bower_components/neon-animation/web-animations.html">
<link rel="import" href="../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="oh-definition.html">

<dom-module id="pg-my-list">
  <template>
    <style include="oh-style">
      .add-something {
        @apply --layout-horizontal;
        @apply --layout-wrap;
      }
      .add-something * {
        margin: 0 1ex;
      }
    </style>

    <app-route
      route="{{route}}"
      pattern="/:word/:def"
      data="{{routeData}}"
      tail="{{subroute}}">
    </app-route>
    
    <firebase-document
      id="userDocument"
      path="/users/{{user.uid}}"
      data="{{__userEntity}}">
    </firebase-document>

    <h1>[[localize('app-shell.menu.MyList')]]</h1>
    Under construction.
    <template is="dom-repeat" items="{{__userEntity.list}}">
      [[stringify(item)]]
    </template>

    <paper-input label="[[localize('pg-my-list.AddAWord')]]" value="{{__search}}">
      <iron-icon icon="icons:search" slot="prefix"></iron-icon>
      <paper-icon-button icon="icons:clear" slot="suffix" on-click="__clearSearch"></paper-icon-button>
    </paper-input>

    <firebase-query
      id="search-query"
      path="/dictionary"
      start-at="[[__search]]"
      end-at="[[_computeEndAt(__search)]]"
      data="{{__searchResult}}"
      limit-to-first="15"
      disabled$="{{isEmpty(__search)}}">
    </firebase-query>
    
    <ul class$="{{_showIfResults(__searchResult.*)}} no-chip">
      <template is="dom-repeat" items="{{__searchResult}}" as="word">
        <template is="dom-repeat" items="{{word.defs}}" as="def" index-as="defIndex">
          <li lang="{{def.lang}}">
            <iron-icon icon="svg-flag-icons:{{def.lang}}"></iron-icon>
            <paper-button on-tap="__addWord">
              <iron-icon icon="icons:add"></iron-icon>
              <b>{{_prettifyWord(word.$key, def)}}</b>
            </paper-button>
          </li>
        </template>
      </template>
    </ul>
    <p class$="{{_showIfNoResult(__searchResult.*, __search)}}">
      [[localize('pg-default.NoMatch')]]
    </p>
  </template>

  <script>
    class PgMyList extends LocalizationMixin(OhUtils(Polymer.Element)) {

      static get is() { return 'pg-my-list'; }

      static get properties() {
        return {
          route: {
            type: Object
          }
        }
      }

      static get observers() {
        return [
          '__observerUserEntity(__userEntity, user)'
          ];
      }

      __observerUserEntity(entity, user) {
        if(!entity || !user)
          return;

        // Create the list the first time
        if(!entity.hasOwnProperty('list')) {
          var path = `/users/${this.user.uid}/list`;
          console.log(path);
          this.$.userDocument.saveValue(path, [])
            .then(()=>{
              console.log(`User successfully saved`);
            })
            .catch((e)=>{
              console.error(`Unable to save user`, e);
            });
        }
      }

      __addWord() {
        console.warn("Not implemented");
      }
      
      __clearSearch() {
        console.warn("Not implemented");
      }
    }

    // Register the x-custom element with the browser
    customElements.define(PgMyList.is, PgMyList);
  </script>

</dom-module>
