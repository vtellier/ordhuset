<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-radio-group/paper-radio-group.html">
<link rel="import" href="../../bower_components/paper-radio-button/paper-radio-button.html">
<link rel="import" href="../ordhuset-app/shared-style.html">

<dom-module id="oh-substantive-editor">
  <template>
    <style include="shared-styles">
      @media screen and (min-width: 640px){
        .half-left {
          width: 50%;
          float: left;
        }
        .single-right {
          width: 50%;
          margin-left: 50%;
        }
      }
    </style>

    <firebase-document
        id="document"
        app-name="ordhuset"
        path="/substantives/[[norwegian]]/[[key]]"
        data="{{substantive}}">
    </firebase-document>

    <!-- gender -->
    <div class="cleared">
      <label id="genderLabel">Gender:</label>
      <paper-radio-group selected="{{substantive.gender}}" aria-labelledby="genderLabel">
        <paper-radio-button name="feminine">feminine</paper-radio-button>
        <paper-radio-button name="masculine">masculine</paper-radio-button>
        <paper-radio-button name="neuter">neuter</paper-radio-button>
      </paper-radio-group>
    </div>

    <!-- singular undefinite -->
    <paper-input class="half-left" label="Singular indefinite" value="{{norwegian}}" maxlength="50" disabled></paper-input>

    <!-- singular definite -->
    <paper-input class="half-left" label="Singular definite" value="{{substantive.singularDefinite}}" maxlength="50"></paper-input>

    <!-- plural undefinite -->
    <paper-input class="half-left" label="Plural indefinite" value="{{substantive.pluralIndefinite}}" maxlength="50"></paper-input>

    <!-- plural definite -->
    <paper-input class="half-left" label="Plural definite" value="{{substantive.pluralDefinite}}" maxlength="50"></paper-input>
    <paper-input class="single-right cleared" label="Alternative plural definite" value="{{substantive.pluralDefiniteAlt}}" maxlength="50"></paper-input>

    <div class="center cleared">
      <paper-button on-tap="save" class$="[[saveClass(key)]]">Save</paper-button>
      <!--<paper-button on-tap="save" disabled$="[[isNotValid(norwegian, substantive)]]">Save</paper-button>-->
      <paper-button on-tap="delete" class$="[[deleteClass(key)]]" disabled$="[[!isDeletable(key)]]">Delete</paper-button>
      <paper-button on-tap="cancel" class$="[[cancelClass(key)]]">Cancel</paper-button>
    </div>

  </template>
  <script>
    Polymer({
      is: 'oh-substantive-editor',
      properties: {
        norwegian: {
          type: String,
          notify: true,
          value: { norwegian: '', english: '', isSubstantive: false, isVerb: false, isAdjective: false },
          observer: 'onNorwegianChange',
        },
        key: {
          type: String,
          notify: true,
          observer: 'onKeyChange',
        },
        substantive: {
          type: Object,
          notify: true,
        },
        deletable: Boolean,
      },

      setToDefault: function() {
        console.log("setToDefault");
        this.substantive = {
              gender: 'feminine',
              //singularIndefinite: '', // The singular indefinite is the key!
              singularDefinite: '',
              pluralIndefinite: '',
              pluralDefinite: '',
              pluralDefiniteAlt: '',
            };
      },

      isValid: function(nor, sub) {
        return nor
            && nor != ''
            && sub
            && (sub.gender == 'feminine' || sub.gender == 'masculine' || sub.gender == 'neuter')
            && sub.singularDefinite != ''
          //  && sub.pluralIndefinite != ''
          //  && sub.pluralDefinite != ''
            ;
      },

      isNotValid: function(nor, sub) {
        return !this.isValid(nor, sub);
      },

      isDeletable: function(theKey) {
        return theKey != '';
      },

      saveClass: function(theKey) {
        if(theKey == '')
          return '';
        else
          return 'hidden';
      },

      deleteClass: function(theKey) {
        if(theKey != '')
          return '';
        else
          return 'hidden';
      },

      cancelClass: function(theKey) {
        if(theKey == '')
          return '';
        else
          return 'hidden';
      },

      save: function() {
        if (this.isValid(this.norwegian, this.substantive)) {
          if (this.$.document.isNew) {
            console.log("Inserting a new substantive: " + JSON.stringify(this.substantive));
            return this.$.document.save('/substantives/' + this.norwegian + '/')
              .then(function() {
                return this.$.document.reset()
                  .then(function() {
                    this.fire('saved', this.key);
                  }.bind(this))
                  .catch(function() {
                    console.warn("Unable to reset after save.");
                  }.bind(this));
              }.bind(this))
              .catch(function() {
                console.warn("Unable to save substantive:\n" + JSON.stringify(this.substantive))
              }.bind(this));
          }
          else {
            console.log("Modifying a substantive: " + JSON.stringify(this.substantive));
            return this.$.document.destroy().then(function() {
              this.$.document.reset().then(function(){
                return this.save();
              }.bind(this));
            }.bind(this)).catch(function () {
              console.warn("Unable to destroy the word in order to reinsert it updated afterward");
              return Promise.reject();
            });
          }
        }
        else {
          console.warn("Tried to push an invalid substantive in database:\n" + JSON.stringify(this.substantive));
          return Promise.reject();
        }
      },

      delete: function (){
        return this.$.document.destroy().then(function() {
            this.$.document.reset().then(function(){
              return Promise.resolve();
            }.bind(this));
          }.bind(this)).catch(function () {
            console.warn("Unable to destroy the word in order to reinsert it updated afterward");
          });
      },

      cancel: function() {
        this.fire('canceled', this.key);
      },

      onKeyChange: function(newData, oldData) {
        console.log("key changed!\n" +
                    "new: " + JSON.stringify(newData) + "\n" +
                    "old: " + JSON.stringify(oldData));
        if(oldData == undefined && newData == "") {
          this.setToDefault();
        }
      },

      onNorwegianChange: function(newData, oldData) {
        console.log("onNorwegianChange!\n" +
                    "new: " + JSON.stringify(newData) + "\n" +
                    "old: " + JSON.stringify(oldData));
      },

    })
  </script>
</dom-module>